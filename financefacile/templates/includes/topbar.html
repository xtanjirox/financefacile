{% load static %}
{% block content %}
<nav class="navbar navbar-expand navbar-light navbar-bg">
    <a class="sidebar-toggle js-sidebar-toggle">
        <i class="hamburger align-self-center"></i>
    </a>
    <form class="d-none d-sm-inline-block position-relative" autocomplete="off" onsubmit="return false;">
        <div class="input-group input-group-navbar">
            <input type="text" class="form-control" id="live-search-input" name="q" placeholder="Search‚Ä¶"
                aria-label="Search" autocomplete="off">
            <button class="btn" type="submit">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="feather feather-search align-middle">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
        </div>
        <div id="live-search-dropdown" class="dropdown-menu"
            style="display:none; width:100%; left:0; right:auto; max-width:400px; max-height:400px; overflow-y:auto; position:absolute; z-index:1051;">
            <div id="live-search-results"></div>
        </div>
    </form>
    <script>
        (function () {
            const input = document.getElementById('live-search-input');
            const dropdown = document.getElementById('live-search-dropdown');
            const resultsDiv = document.getElementById('live-search-results');
            let timeout = null;

            input.addEventListener('input', function () {
                const q = input.value.trim();
                if (timeout) clearTimeout(timeout);
                if (q.length < 2) {
                    dropdown.style.display = 'none';
                    resultsDiv.innerHTML = '';
                    return;
                }
                timeout = setTimeout(() => {
                    fetch(`/api/live-search/?q=${encodeURIComponent(q)}`)
                        .then(resp => resp.json())
                        .then(data => {
                            let html = '';
                            if (data.products.length) {
                                html += '<div class="dropdown-header">Products</div>';
                                data.products.forEach(p => {
                                    html += `<a class='dropdown-item' href='${p.url}'>üõí ${p.name} <small class='text-muted'>(${p.sku})</small></a>`;
                                });
                            }
                            if (data.invoices.length) {
                                html += '<div class="dropdown-header">Invoices</div>';
                                data.invoices.forEach(i => {
                                    html += `<a class='dropdown-item' href='${i.url}'>#${i.id} <small class='text-muted'>${i.date}</small></a>`;
                                });
                            }
                            if (data.categories.length) {
                                html += '<div class="dropdown-header">Categories</div>';
                                data.categories.forEach(c => {
                                    html += `<a class='dropdown-item' href='${c.url}'>üè∑Ô∏è ${c.name}</a>`;
                                });
                            }
                            if (!html) {
                                html = '<span class="dropdown-item text-muted">No results</span>';
                            }
                            resultsDiv.innerHTML = html;
                            dropdown.style.display = 'block';
                        });
                }, 200);
            });
            document.addEventListener('click', function (e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
            input.addEventListener('focus', function () {
                if (resultsDiv.innerHTML) dropdown.style.display = 'block';
            });
        })();
    </script>
    <div class="navbar-collapse collapse">
        <ul class="navbar-nav navbar-align">
            
            
            <li class="nav-item dropdown">
                <a class="nav-icon dropdown-toggle d-inline-block d-sm-none" href="#" data-bs-toggle="dropdown">
                    {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" class="avatar img-fluid rounded-circle" style="width: 32px; height: 32px; object-fit: cover;"
                            alt="{{ user.username }}" />
                    {% else %}
                        <div class="avatar-circle d-inline-flex align-items-center justify-content-center" style="width: 32px; height: 32px; background-color: #7cb9e8; border-radius: 50%;">
                            <span style="color: white; font-size: 0.75rem; font-weight: bold;">{{ user.profile.get_initials }}</span>
                        </div>
                    {% endif %}
                </a>

                <a class="nav-link dropdown-toggle d-none d-sm-inline-block" href="#" data-bs-toggle="dropdown">
                    {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" class="avatar img-fluid rounded-circle me-1" style="width: 36px; height: 36px; object-fit: cover;"
                            alt="{{ user.username }}" />
                    {% else %}
                        <div class="avatar-circle d-inline-flex align-items-center justify-content-center me-1" style="width: 36px; height: 36px; background-color: #7cb9e8; border-radius: 50%;">
                            <span style="color: white; font-size: 0.875rem; font-weight: bold;">{{ user.profile.get_initials }}</span>
                        </div>
                    {% endif %}
                    <span class="text-dark">{{ user.get_full_name|default:user.username }}</span>
                </a>
                <div class="dropdown-menu dropdown-menu-end">
                    <a class="dropdown-item" href="{% url 'auth:profile' %}"><i class="align-middle me-1"
                            data-feather="user"></i> Profile</a>
                    <a class="dropdown-item" href="{% url 'auth:profile-edit' %}"><i class="align-middle me-1" data-feather="edit"></i>
                        Edit Profile</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="{% url 'auth:password-change' %}"><i class="align-middle me-1" data-feather="key"></i>
                        Change Password</a>
                    {% if user.profile.company and user.profile.is_company_admin %}
                    <a class="dropdown-item" href="{% url 'organizations:company-settings' user.profile.company.id %}"><i class="align-middle me-1" data-feather="settings"></i>
                        Company Settings</a>
                    {% endif %}
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="{% url 'auth:logout' %}">Log out</a>
                </div>
            </li>
        </ul>
    </div>
</nav>
{% endblock content %}