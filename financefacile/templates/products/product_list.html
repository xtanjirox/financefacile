{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load django_tables2 %}

{% block sidebar %}
  {% include 'includes/sidebar.html' %}
{% endblock sidebar %}

{% block topbar %}
  {% include 'includes/topbar.html' %}
{% endblock topbar %}

{% block footer %}
  {% include 'includes/footer.html' %}
{% endblock footer %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css">
<style>
  /* Enhanced DataTables search styling */
  .dataTables_wrapper .dataTables_filter {
    margin-bottom: 20px;
    float: none !important;
    text-align: left !important;
    width: 100%;
  }
  
  .dataTables_wrapper .dataTables_filter input {
    width: 100% !important;
    margin-left: 0 !important;
    padding: 12px 20px;
    border-radius: 50px;
    border: 2px solid #e0e6ed;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    font-size: 1.1rem;
    background-color: #f8fafc;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23a0aec0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
    background-repeat: no-repeat;
    background-position: right 20px center;
    padding-right: 50px;
    transition: all 0.3s ease;
  }
  
  .dataTables_wrapper .dataTables_filter input:focus {
    border-color: #7cb9e8;
    box-shadow: 0 0 0 4px rgba(124, 185, 232, 0.25);
    outline: none;
    background-color: #fff;
  }
  
  /* Add label for search */
  .dataTables_wrapper .dataTables_filter label {
    font-weight: bold;
    color: #39739d;
    font-size: 1.1rem;
    margin-bottom: 8px;
    display: block;
  }
  
  /* Adjust the length menu position */
  .dataTables_wrapper .dataTables_length {
    margin-top: 15px;
  }
  
  /* Clickable rows styling */
  #products-table tbody tr {
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  
  #products-table tbody tr:hover {
    background-color: rgba(124, 185, 232, 0.1) !important;
  }
  
  /* Ensure action buttons don't trigger row click */
  #products-table .btn-group {
    position: relative;
    z-index: 10;
  }
  .filter-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
  }
  
  /* Select2 Custom Styling */
  .select2-container--default .select2-selection--multiple {
    border-color: #ced4da;
    border-radius: 0.375rem;
    min-height: 38px;
  }
  
  .select2-container--default.select2-container--focus .select2-selection--multiple {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }
  
  .select2-container--default .select2-selection--multiple .select2-selection__choice {
    background-color: #e7f1fa;
    border: 1px solid #7cb9e8;
    border-radius: 0.25rem;
    padding: 0.25rem 0.5rem;
    margin-top: 0.25rem;
    color: #39739d;
  }
  
  .select2-container--default .select2-selection__choice__remove {
    color: #39739d;
    margin-right: 5px;
  }
  
  .select2-dropdown {
    border-color: #86b7fe;
    border-radius: 0.375rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }
  
  .select2-results__option--highlighted {
    background-color: #e7f1fa !important;
    color: #39739d !important;
  }
  
  .select2-container--default .select2-results__option--selected {
    background-color: #7cb9e8;
    color: white;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
  <div class="d-flex justify-content-between align-items-center mb-3 mt-4">
    <h2 class="fw-bold mb-0" style="color: #39739d;"><i class="fa-solid fa-boxes-stacked me-2" style="color: #7cb9e8;"></i>Products</h2>
    <div class="d-flex gap-2">
      <a href="{% url 'category-create' %}" class="btn btn-outline-primary shadow-sm rounded-pill px-4" style="border-color: #7cb9e8; color: #39739d; font-weight: 600;">
        <i class="fa fa-tags"></i> Add Category
      </a>
      <a href="{% url 'product-create' %}" class="btn btn-primary shadow-sm rounded-pill px-4" style="background: #7cb9e8; border: none; font-weight: 600;">
        <i class="fa fa-plus"></i> Add Product
      </a>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card mb-3 shadow-sm border-0" style="background: #e3f2fd; border-radius: 14px;">
        <div class="card-body">
          <h5 class="card-title" style="color: #1976d2; font-weight: 600;">
            Total Products
          </h5>
          <p class="card-text display-6" style="color: #1976d2; font-weight: 700;">
            {{ total_products }}
          </p>
          <p class="text-muted small">Total items in inventory</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card mb-3 shadow-sm border-0" style="background: #e8f5e9; border-radius: 14px;">
        <div class="card-body">
          <h5 class="card-title" style="color: #388e3c; font-weight: 600;">
            Total Inventory Value
          </h5>
          <p class="card-text display-6" style="color: #388e3c; font-weight: 700;">
            {{ total_inventory_value|floatformat:2 }} {{ currency_symbol|default:'€' }}
          </p>
          <p class="text-muted small">Based on unit cost × quantity</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card mb-3 shadow-sm border-0" style="background: #e1f5fe; border-radius: 14px;">
        <div class="card-body">
          <h5 class="card-title" style="color: #0288d1; font-weight: 600;">
            Potential Revenue
          </h5>
          <p class="card-text display-6" style="color: #0288d1; font-weight: 700;">
            {{ total_potential_revenue|floatformat:2 }} {{ currency_symbol|default:'€' }}
          </p>
          <p class="text-muted small">Based on selling price × quantity</p>
        </div>
      </div>
    </div>
  </div>

  <!-- DataTables will handle filtering and searching -->


  <div class="row">
    <div class="col-12">
      <div class="card flex-fill shadow-sm border-0" style="border-radius: 14px;">
        <div class="card-header d-flex justify-content-between align-items-center py-3" style="background: #e7f1fa; border-top-left-radius: 14px; border-top-right-radius: 14px; border-bottom: 1px solid #e0e6ed;">
          <h5 class="card-title mb-0 fw-bold" style="color: #39739d;">
            <i class="fas fa-table me-2" style="color: #7cb9e8;"></i>Products
          </h5>
        </div>
        <div class="card-body p-4">
          <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
          <link rel="stylesheet" href="{% static 'css/datatables_pastel.css' %}">
          <div class="table-responsive">
            <table id="products-table" class="table align-middle datatable" style="width:100%; background:#fff; border-radius:12px; overflow:hidden;">
              <thead style="background:#e7f1fa; color:#39739d; font-weight:600;">
                <tr>
                  <th>Name</th>
                  <th>SKU</th>
                  <th>Category</th>
                  <th>Quantity</th>
                  <th>Unit Cost</th>
                  <th>Selling Price</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for product in products %}
                <tr>
                  <td>{{ product.name }}</td>
                  <td>{{ product.sku|default:'-' }}</td>
                  <td>{{ product.category.name|default:'-' }}</td>
                  <td>{{ product.quantity }}</td>
                  <td>{{ product.unit_cost|floatformat:2 }} €</td>
                  <td>{{ product.selling_price|floatformat:2 }} €</td>
                  <td>
                    <div class="btn-group">
                      <a href="{% url 'product-detail' product.id %}" class="btn btn-sm btn-primary" data-bs-toggle="tooltip" title="View Details"><i class="fas fa-eye"></i></a>
                      <a href="{% url 'product-update' product.id %}" class="btn btn-sm btn-info" data-bs-toggle="tooltip" title="Edit"><i class="fas fa-edit"></i></a>
                      <a href="{% url 'product-delete' product.id %}" class="btn btn-sm btn-danger" data-bs-toggle="tooltip" title="Delete"><i class="fas fa-trash"></i></a>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="7" class="text-center py-4">
                    <div class="d-flex flex-column align-items-center">
                      <i class="fas fa-box-open text-muted mb-3" style="font-size: 3rem;"></i>
                      <h5 class="text-muted">No products found</h5>
                      <p class="text-muted">Get started by adding your first product</p>
                      <a href="{% url 'product-create' %}" class="btn btn-primary mt-2">
                        <i class="fa fa-plus me-2"></i> Add Product
                      </a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <!-- Product table -->
          <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
          <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
          <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
          <script src="{% static 'js/datatables_init.js' %}"></script>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
{% endblock %}
