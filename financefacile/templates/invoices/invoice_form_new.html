{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<script>
  // Add invoice-form class to body when document is ready
  document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('invoice-form');
  });
</script>
{% endblock extra_head %}

{% block sidebar %}
{% include 'includes/sidebar.html' %}
{% endblock sidebar %}

{% block topbar %}
{% include 'includes/topbar.html' %}
{% endblock topbar %}

{% block extra_css %}
<style>
  .highlight-update {
    background-color: #ffffcc !important;
    transition: background-color 1s;
  }
</style>
{% endblock extra_css %}

{% block extra_js %}
{{ block.super }}
<script>
  // Provide product prices for JS
  window.PRODUCT_PRICES = {};
  {% if products %}
    {% for product in products %}
    window.PRODUCT_PRICES["{{ product.id }}"] = "{{ product.selling_price }}";
    {% endfor %}
  {% endif %}
  
  // Check if we're in update mode (invoice already exists)
  window.isUpdateMode = {% if form.instance.id %}true{% else %}false{% endif %};
  console.log('Is update mode:', window.isUpdateMode);
  
  // Debug: Log all product prices
  console.log('DEBUG: Product prices object:', window.PRODUCT_PRICES);
</script>
{% endblock extra_js %}

{% block footer %}
{% include 'includes/footer.html' %}
{% endblock footer %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
          <h6 class="m-0 font-weight-bold text-primary">{{ page_title }}</h6>
        </div>
        <div class="card-body">
          {% if form.errors %}
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <div class="d-flex">
              <div class="me-3">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
              </div>
              <div>
                <h5 class="alert-heading">Please correct the errors below</h5>
                <ul class="mb-0">
                  {% for field in form %}
                  {% for error in field.errors %}
                  <li>{{ field.label }}: {{ error }}</li>
                  {% endfor %}
                  {% endfor %}
                  {% for error in form.non_field_errors %}
                  <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endif %}

          {% if formset.non_form_errors %}
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <div class="d-flex">
              <div class="me-3">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
              </div>
              <div>
                <h5 class="alert-heading">Please correct the errors below</h5>
                <ul class="mb-0">
                  {% for error in formset.non_form_errors %}
                  <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endif %}

          <form method="post" id="invoice-form" autocomplete="off" class="w-100">
            {% csrf_token %}
            {{ formset.management_form }}
            
            <div class="card shadow-sm mb-4">
              <div class="card-header py-3">
                <h5 class="mb-0 fw-bold text-primary">
                  <i class="fas fa-info-circle me-2"></i>Invoice Details
                </h5>
              </div>
              <div class="card-body">
              <div class="row g-3">
                <!-- TVA Rate Field -->
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-semibold" for="id_tva_rate">TVA Rate (%)</label>
                  <input type="text" name="tva_rate" id="id_tva_rate" class="form-control" 
                    value="{% if form.instance.tva_rate %}{{ form.instance.tva_rate|stringformat:".2f" }}{% elif form.tva_rate.value %}{{ form.tva_rate.value|stringformat:".2f" }}{% else %}{{ form.initial.tva_rate|default:'19.0'|stringformat:".2f" }}{% endif %}"
                    style="color: black !important; background-color: white !important; z-index: 9999 !important; opacity: 1 !important;" >
                  <small class="form-text text-muted">Default rate from company settings: {{ company_default_tva_rate }}%</small>
                  {% for error in form.tva_rate.errors %}
                  <div class="invalid-feedback d-block">{{ error }}</div>
                  {% endfor %}
                </div>

                <!-- Stamp Fee Field -->
                <div class="col-md-6 mb-3 align-self-end">
                  <div class="form-check mt-md-0 pt-md-2">
                    <input class="form-check-input" type="checkbox" name="include_stamp_fee" id="id_include_stamp_fee" 
                      {% if form.include_stamp_fee.value or form.initial.include_stamp_fee %}checked{% endif %}>
                    <label class="form-check-label" for="id_include_stamp_fee">
                      Include Stamp Fee
                    </label>
                    <small class="form-text text-muted d-block">{{ form.include_stamp_fee.help_text }}</small>
                    {% for error in form.include_stamp_fee.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                  </div>
                </div>

                <!-- Client Name Field -->
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-semibold" for="id_client_name">Client Name</label>
                  <input type="text" name="client_name" id="id_client_name" class="form-control" placeholder="Client name"
                    {% if form.client_name.value %}value="{{ form.client_name.value }}"{% endif %}>
                  {% if form.client_name.help_text %}
                  <small class="form-text text-muted">{{ form.client_name.help_text }}</small>
                  {% endif %}
                  {% for error in form.client_name.errors %}
                  <div class="invalid-feedback d-block">{{ error }}</div>
                  {% endfor %}
                </div>

                <!-- Client Address Field -->
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-semibold" for="id_client_address">Client Address</label>
                  <textarea name="client_address" id="id_client_address" class="form-control" rows="2"
                    placeholder="Client address">{% if form.client_address.value %}{{ form.client_address.value }}{% endif %}</textarea>
                  {% if form.client_address.help_text %}
                  <small class="form-text text-muted">{{ form.client_address.help_text }}</small>
                  {% endif %}
                  {% for error in form.client_address.errors %}
                  <div class="invalid-feedback d-block">{{ error }}</div>
                  {% endfor %}
                </div>
              </div> <!-- end row g-3 -->
              </div> <!-- end card-body -->
            </div> <!-- end card -->

            <div class="card shadow-sm mb-4">
              <div class="card-header py-3">
                <h5 class="mb-0 fw-bold text-primary">
                  <i class="fas fa-shopping-cart me-2"></i>Invoice Items
                </h5>
              </div>
              <div class="card-body p-0"> <!-- p-0 to allow table to span full width of card body -->
                <div class="table-responsive">
                  <table class="table table-bordered table-hover table-sm mb-0" id="invoice-items-table">
                  <thead class="table-light">
                    <tr>
                      <th scope="col" style="width: 35%;">Product</th>
                      <th scope="col" style="width: 15%;" class="text-end">Quantity</th>
                      <th scope="col" style="width: 20%;" class="text-end">Selling Price</th>
                      <th scope="col" style="width: 20%;" class="text-end">Item Total</th>
                      <th scope="col" style="width: 10%;" class="text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="invoice-items-body">
                    {% for form in formset.forms %}
                    {% if form.instance.id or form.product.value or forloop.first and not form.instance.id %}
                    <tr class="item-form">
                      {{ form.id }}
                      <td>
                        <select name="{{ form.product.html_name }}" id="{{ form.product.auto_id }}" class="form-control select2-product">
                          <option value="">Select a product...</option>
                          {% for product in products %}
                          <option value="{{ product.id }}" data-price="{{ product.selling_price }}" {% if form.product.value|stringformat:'s' == product.id|stringformat:'s' %}selected{% endif %}>{{ product.name }}</option>
                          {% endfor %}
                        </select>
                        {% for error in form.product.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                      </td>
                      <td>
                        <input type="text" 
                           name="{{ form.quantity.html_name }}" 
                           id="{{ form.quantity.auto_id }}" 
                           class="form-control quantity-input-debug {{ form.quantity.field.widget.attrs.class }}" 
                           value="{{ form.quantity.value|default:'1' }}" 
                           data-field-type="quantity"
                           min="1" 
                           data-bs-toggle="tooltip" 
                           title="{{ form.quantity.field.widget.attrs.title|default:'Enter quantity (must not exceed available stock)' }}"
                           {% if form.quantity.help_text %}aria-describedby="{{ form.quantity.auto_id }}_helptext"{% endif %}>
                    {% if form.quantity.help_text %}
                      <small id="{{ form.quantity.auto_id }}_helptext" class="form-text text-muted">{{ form.quantity.help_text }}</small>
                    {% endif %}
                        {% for error in form.quantity.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                      </td>
                      <td>
                        <input type="text" 
                               name="{{ form.selling_price.html_name }}" 
                               id="{{ form.selling_price.auto_id }}" 
                               class="form-control selling-price-input-debug" 
                               value="{% if form.selling_price.value %}{{ form.selling_price.value|stringformat:'.2f'|safe }}{% else %}0.00{% endif %}" 
                               data-field-type="selling-price" >
                        {% for error in form.selling_price.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                      </td>
                      <td>
                        <input type="number" class="form-control item-total" readonly>
                      </td>
                      <td>
                        <button type="button" class="btn btn-sm btn-danger delete-row">
                          <i class="fas fa-trash"></i> Remove
                        </button>
                      </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                  </tbody>
                </table>
              </div> <!-- end table-responsive -->
            </div> <!-- end card-body p-0 -->
            <div class="card-footer bg-light py-3 text-end">
              <button type="button" id="add-item" class="btn btn-primary btn-sm">
                <i class="fas fa-plus me-1"></i> Add Item
              </button>
            </div>
          </div> <!-- end card shadow-sm mb-4 for Invoice Items -->

              <!-- Empty form template for JavaScript -->
              <div id="empty-form" class="d-none">
                {% with form=formset.empty_form %}
                <tr class="item-form">
                  {{ form.id }}
                  <td>
                    <select name="{{ form.product.html_name }}" id="{{ form.product.auto_id }}" class="form-control select2-product">
                      <option value="">Select a product...</option>
                      {% for product in products %}
                      <option value="{{ product.id }}" data-price="{{ product.selling_price }}" {% if form.product.value|stringformat:'s' == product.id|stringformat:'s' %}selected{% endif %}>{{ product.name }}</option>
                      {% endfor %}
                    </select>
                    {% for error in form.product.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                  </td>
                  <td>
                    <input type="text" 
                           name="{{ form.quantity.html_name }}" 
                           id="{{ form.quantity.auto_id }}" 
                           class="form-control quantity-input-debug" 
                           value="{{ form.quantity.value|default:'1' }}" 
                           data-field-type="quantity" >
                    {% for error in form.quantity.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                  </td>
                  <td>
                    <input type="text" 
                           name="{{ form.selling_price.html_name }}" 
                           id="{{ form.selling_price.auto_id }}" 
                           class="form-control selling-price-input-debug" 
                           value="{{ form.selling_price.value|default:'0.00' }}" 
                           data-field-type="selling-price" >
                    {% for error in form.selling_price.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                  </td>
                  <td>
                    <input type="number" class="form-control item-total" readonly>
                  </td>
                  <td>
                    <button type="button" class="btn btn-sm btn-danger delete-row">
                      <i class="fas fa-trash"></i> Remove
                    </button>
                  </td>
                </tr>
                {% endwith %}
              </div>
            </div>
            
            <div class="row mb-4">
              <div class="col-12">
                <div class="card shadow-sm">
                  <div class="card-header py-3">
                    <h5 class="mb-0 fw-bold text-primary"><i class="fas fa-calculator me-2"></i>Summary</h5>
                  </div>
                  <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                      <span class="fw-semibold">Subtotal:</span>
                      <span id="subtotal" class="text-end">0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span class="fw-semibold">TVA (<span id="tva-rate-display">{% if form.instance.tva_rate %}{{ form.instance.tva_rate|stringformat:".2f" }}{% elif form.tva_rate.value %}{{ form.tva_rate.value|stringformat:".2f" }}{% else %}{{ form.initial.tva_rate|default:'19.0'|stringformat:".2f" }}{% endif %}</span>%):</span>
                      <span id="tva-amount" class="text-end">0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2" id="stamp-fee-row">
                      <span class="fw-semibold">Stamp Fee:</span>
                      <span id="stamp-fee" class="text-end">0.00</span>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between fw-bold h5 mb-0">
                      <span class="text-success">Total:</span>
                      <span id="total-amount" class="text-end text-success">0.00</span>
                    </div>
                    <input type="hidden" name="invoice_total" id="id_invoice_total">
                  </div>
                </div>
              </div>
            </div> <!-- end row for totals -->
            
            <div class="d-flex justify-content-end">
              <a href="{% url 'invoice-list' %}" class="btn btn-secondary me-2">Cancel</a>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Invoice
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block script_content %}
<!-- Select2 is already loaded in the base template -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Debug information
    console.log('Invoice form initialized');
    console.log('Product prices:', window.PRODUCT_PRICES);
    
    // Function to normalize number input (handle commas and periods)
    function normalizeNumber(value) {
      if (typeof value === 'string') {
        // Replace commas with periods for parsing
        value = value.replace(/,/g, '.');
        // Remove any non-numeric characters except decimal point
        value = value.replace(/[^0-9.]/g, '');
      }
      const num = parseFloat(value);
      return isNaN(num) ? 0 : num;
    }
    
    // Function to calculate the total for a row
    window.calculateRowTotal = function(row, quantity, price) {
      console.log('Calculating row total for:', row);
      console.log('Quantity:', quantity, 'Price:', price);
      
      // Normalize inputs
      quantity = normalizeNumber(quantity);
      price = normalizeNumber(price);
      
      console.log('DEBUG: Calculating row total - Quantity:', quantity, 'Price:', price);
      const total = quantity * price;
      console.log('DEBUG: Row total calculated:', total);
      
      // Update the total display in the row
      const totalInput = row.find('.item-total');
      if (totalInput.length > 0) {
        totalInput.val(total.toFixed(2));
        console.log('DEBUG: Updated row total display to:', total.toFixed(2));
      } else {
        console.error('DEBUG: Could not find total input in row');
      }
      
      // Update all totals
      updateAllTotals();
    };
    
    // Function to update all totals
    window.updateAllTotals = function() {
      console.log('Updating all totals');
      
      // Calculate subtotal
      let subtotal = 0;
      $('.item-total').each(function() {
        // Normalize the value to handle comma decimal separators
        const rowTotal = normalizeNumber($(this).val());
        subtotal += rowTotal;
      });
      
      console.log('Subtotal:', subtotal);
      
      // Get TVA rate
      const tvaRateElement = document.getElementById('id_tva_rate');
      let tvaRate = 19; // Default TVA rate
      
      if (tvaRateElement) {
        // Normalize the TVA rate to handle comma decimal separators
        tvaRate = normalizeNumber(tvaRateElement.value);
        if (tvaRate === 0) tvaRate = 19; // Fallback to default if parsing failed
      } else if (tvaRateDisplay) {
        tvaRate = parseFloat(tvaRateDisplay.textContent) || tvaRate;
      }
      
      console.log('TVA Rate:', tvaRate);
      
      // Calculate TVA amount
      const tvaAmount = subtotal * (tvaRate / 100);
      
      // Get stamp fee
      const stampFeeElement = document.getElementById('id_stamp_fee');
      const includeStampFeeCheckbox = document.getElementById('id_include_stamp_fee');
      let stampFee = 0;
      
      if (stampFeeElement) {
        stampFee = normalizeNumber(stampFeeElement.value);
      }
      
      // Only include stamp fee if checkbox is checked
      if (includeStampFeeCheckbox && !includeStampFeeCheckbox.checked) {
        stampFee = 0;
      }
      
      console.log('Stamp Fee:', stampFee);
      
      // Calculate total
      const total = subtotal + tvaAmount + stampFee;
      
      // Update the display
      $('#subtotal').text(subtotal.toFixed(2));
      $('#tva-amount').text(tvaAmount.toFixed(2));
      $('#stamp-fee').text(stampFee.toFixed(2));
      $('#total-amount').text(total.toFixed(2));
      $('#id_invoice_total').val(total.toFixed(2));
      
      console.log('Updated totals - Subtotal:', subtotal.toFixed(2), 'TVA:', tvaAmount.toFixed(2), 'Total:', total.toFixed(2));
    };
    
    // Initialize Select2 for product dropdowns
    initializeSelect2();
    
    // Setup event handlers for existing rows
    setupExistingRows();
    
    // Setup add item button
    setupAddItemButton();
    
    // Calculate initial totals
    updateAllTotals();
    
    // Function to initialize Select2 for product dropdowns
    function initializeSelect2() {
      console.log('Initializing Select2 for product dropdowns');
      $('.select2-product').select2({
        placeholder: 'Select a product...',
        allowClear: true,
        width: '100%'
      });
      
      // Add change event handler to all product dropdowns
      $('.select2-product').on('change', function() {
        console.log('DEBUG: Product dropdown changed');
        const productId = $(this).val();
        console.log('DEBUG: Selected product ID:', productId);
        
        if (productId) {
          // Find the price input in the same row
          const row = $(this).closest('tr');
          console.log('DEBUG: Found row:', row);
          
          // Try different selectors to find the price input
          let priceInput = row.find('input[id$="-selling_price"]');
          if (priceInput.length === 0) {
            priceInput = row.find('input[name$="-selling_price"]');
          }
          if (priceInput.length === 0) {
            // As a fallback, get all inputs and find the one in the third cell (price column)
            const inputs = row.find('td:eq(2) input');
            if (inputs.length > 0) {
              priceInput = inputs.first();
            }
          }
          
          console.log('DEBUG: Price input found:', priceInput.length > 0, priceInput);
          
          // Try to get the price from the data attribute first
          let price = $(this).find('option:selected').data('price');
          console.log('DEBUG: Price from data attribute:', price);
          
          // If not available, try the PRODUCT_PRICES object
          if (!price && window.PRODUCT_PRICES && productId in window.PRODUCT_PRICES) {
            price = window.PRODUCT_PRICES[productId];
            console.log('DEBUG: Price from PRODUCT_PRICES:', price);
          }
          
          // Set the price in the price input
          if (price && priceInput.length > 0) {
            console.log('DEBUG: Setting price input value to:', price);
            console.log('DEBUG: Price input type:', priceInput.prop('tagName'), 'ID:', priceInput.attr('id'), 'Name:', priceInput.attr('name'));
            
            // Convert price to a proper number format
            let numericPrice;
            if (typeof price === 'string') {
              // Handle both comma and period decimal separators
              // First, replace commas with periods for parsing
              price = price.replace(/,/g, '.');
              // Then remove any non-numeric characters except decimal point
              price = price.replace(/[^0-9.]/g, '');
              numericPrice = parseFloat(price);
            } else {
              numericPrice = parseFloat(price);
            }
            
            // Ensure it's a valid number
            if (isNaN(numericPrice)) {
              numericPrice = 0;
            }
            
            // Format to 2 decimal places
            numericPrice = numericPrice.toFixed(2);
            
            console.log('DEBUG: Converted price to numeric format:', numericPrice);
            
            // Use a more direct approach to update the field
            // First, get the DOM element directly
            const priceInputElement = priceInput.get(0);
            if (priceInputElement) {
              // Set the value property directly
              priceInputElement.value = numericPrice;
              
              // Create and dispatch an input event to trigger any listeners
              const event = new Event('input', { bubbles: true });
              priceInputElement.dispatchEvent(event);
              
              // Also dispatch a change event
              const changeEvent = new Event('change', { bubbles: true });
              priceInputElement.dispatchEvent(changeEvent);

              // Force browser reflow/repaint
              priceInputElement.style.display = 'none';
              // Reading offsetHeight is a common trick to trigger reflow
              // eslint-disable-next-line @typescript-eslint/no-unused-vars
              const hack = priceInputElement.offsetHeight;
              priceInputElement.style.display = '';
              
              console.log('DEBUG: Set price using vanilla JS, dispatched events, and forced reflow');
            }
            
            console.log('DEBUG: Price input value after setting:', priceInputElement ? priceInputElement.value : 'N/A');
            
            // Force a visual update by adding a temporary class
            priceInput.addClass('highlight-update');
            setTimeout(() => {
              priceInput.removeClass('highlight-update');
            }, 1000);
            
            // Trigger the calculation of the row total
            const quantityInput = row.find('input[id$="-quantity"]');
            const quantity = quantityInput.length > 0 ? parseFloat(quantityInput.val()) || 1 : 1;
            
            console.log('DEBUG: Quantity input found:', quantityInput.length > 0, 'Value:', quantity);
            
            calculateRowTotal(row, quantity, parseFloat(price));
            // Update all totals
            updateAllTotals();
          } else {
            console.error('DEBUG: No price found for product ID:', productId, 'or price input not found');
          }
        } else {
          console.log('DEBUG: No product selected');
        }
      });
    }
    
    // Function to initialize a new Select2 instance
    function initializeNewSelect2(element) {
      console.log('Initializing new Select2 for element:', element.id);
      $(element).addClass('select2-product');
      $(element).select2({
        width: '100%',
        theme: 'classic',
        placeholder: 'Select a product...',
        allowClear: true,
        dropdownParent: $('#invoice-form')
      });
      
      // Add change event handler to the new product dropdown
      $(element).on('change', function() {
        console.log('DEBUG: NEW ROW - Product dropdown changed');
        const productId = $(this).val();
        console.log('DEBUG: NEW ROW - Selected product ID:', productId);
        
        if (productId) {
          // Find the price input in the same row
          const row = $(this).closest('tr');
          console.log('DEBUG: NEW ROW - Found row:', row);
          
          // Try different selectors to find the price input
          let priceInput = row.find('input[id$="-selling_price"]');
          if (priceInput.length === 0) {
            priceInput = row.find('input[name$="-selling_price"]');
          }
          if (priceInput.length === 0) {
            // As a fallback, get all inputs and find the one in the third cell (price column)
            const inputs = row.find('td:eq(2) input');
            if (inputs.length > 0) {
              priceInput = inputs.first();
            }
          }
          
          console.log('DEBUG: NEW ROW - Price input found:', priceInput.length > 0, priceInput);
          console.log('DEBUG: NEW ROW - All inputs in row:', row.find('input').length, row.find('input'));
          
          // Try to get the price from the data attribute first
          let price = $(this).find('option:selected').data('price');
          console.log('DEBUG: NEW ROW - Price from data attribute:', price);
          
          // If not available, try the PRODUCT_PRICES object
          if (!price && window.PRODUCT_PRICES && productId in window.PRODUCT_PRICES) {
            price = window.PRODUCT_PRICES[productId];
            console.log('DEBUG: NEW ROW - Price from PRODUCT_PRICES:', price);
          }
          
          // Set the price in the price input
          if (price && priceInput.length > 0) {
            console.log('DEBUG: NEW ROW - Setting price input value to:', price);
            console.log('DEBUG: NEW ROW - Price input type:', priceInput.prop('tagName'), 'ID:', priceInput.attr('id'), 'Name:', priceInput.attr('name'));
            
            // Use a more direct approach to update the field
            // First, get the DOM element directly
            const priceInputElement = priceInput.get(0);
            if (priceInputElement) {
              // Set the value property directly
              priceInputElement.value = price;
              
              // Create and dispatch an input event to trigger any listeners
              const event = new Event('input', { bubbles: true });
              priceInputElement.dispatchEvent(event);
              
              // Also dispatch a change event
              const changeEvent = new Event('change', { bubbles: true });
              priceInputElement.dispatchEvent(changeEvent);

              // Force browser reflow/repaint
              priceInputElement.style.display = 'none';
              // Reading offsetHeight is a common trick to trigger reflow
              // eslint-disable-next-line @typescript-eslint/no-unused-vars
              const hack = priceInputElement.offsetHeight;
              priceInputElement.style.display = '';
              
              console.log('DEBUG: NEW ROW - Set price using vanilla JS, dispatched events, and forced reflow');
            }
            
            console.log('DEBUG: NEW ROW - Price input value after setting:', priceInputElement ? priceInputElement.value : 'N/A');
            
            // Force a visual update by adding a temporary class
            priceInput.addClass('highlight-update');
            setTimeout(() => {
              priceInput.removeClass('highlight-update');
            }, 1000);
            
            // Trigger the calculation of the row total
            const quantityInput = row.find('input[id$="-quantity"]');
            const quantity = quantityInput.length > 0 ? parseFloat(quantityInput.val()) || 1 : 1;
            
            console.log('DEBUG: NEW ROW - Quantity input found:', quantityInput.length > 0, 'Value:', quantity);
            
            calculateRowTotal(row, quantity, parseFloat(price));
            // Update all totals
            updateAllTotals();
          } else {
            console.error('DEBUG: NEW ROW - No price found for product ID:', productId, 'or price input not found');
          }
        } else {
          console.log('DEBUG: NEW ROW - No product selected');
        }
      });
    }
    
    // Function to setup existing rows
    function setupExistingRows() {
      console.log('Setting up existing rows');
      
      // Get all existing item rows
      const rows = document.querySelectorAll('#invoice-items-body .item-form');
      console.log('Found', rows.length, 'existing rows');
      
      // If there are no rows and we're not in update mode, add an empty row
      if (rows.length === 0 && !window.isUpdateMode) {
        console.log('No existing rows and not in update mode, adding an empty row');
        // Trigger the add item button click to add an empty row
        document.getElementById('add-item').click();
      }
      
      // Setup event handlers for each row
      rows.forEach(row => {
        setupRowEventHandlers(row);
        
        // Calculate initial row total for existing items
        const quantityInput = row.querySelector('input[name*="quantity"]');
        const priceInput = row.querySelector('input[name*="selling_price"]');
        const totalInput = row.querySelector('.item-total');
        
        if (quantityInput && priceInput && totalInput && quantityInput.value && priceInput.value) {
          const quantity = parseFloat(quantityInput.value) || 0;
          const price = parseFloat(priceInput.value) || 0;
          const total = quantity * price;
          totalInput.value = total.toFixed(2);
        }
      });
      
      // Update all totals after setting up rows
      updateAllTotals();
    }
    
    // Function to setup event handlers for a specific row
    function setupRowEventHandlers(row) {
      // Product selection change handler
      const productSelect = row.querySelector('select[name*="product"]');
      if (productSelect) {
        productSelect.addEventListener('change', function() {
          updateRowPrice(row);
        });
        
        // Initialize with current value if any
        if (productSelect.value) {
          updateRowPrice(row);
        }
      }
      
      // Quantity change handler
      const quantityInput = row.querySelector('input[name*="quantity"]');
      if (quantityInput) {
        quantityInput.addEventListener('input', function() {
          updateRowTotal(row);
        });
      }
      
      // Price change handler
      const priceInput = row.querySelector('input[name*="selling_price"]');
      if (priceInput) {
        priceInput.addEventListener('input', function() {
          updateRowTotal(row);
        });
      }
      
      // Delete button handler
      const deleteButton = row.querySelector('.delete-row');
      if (deleteButton) {
        deleteButton.addEventListener('click', function() {
          row.remove();
          updateFormCount();
          updateAllTotals();
        });
      }
    }
    
    // Function to update the price based on selected product
    function updateRowPrice(row) {
      const productSelect = row.querySelector('select[name*="product"]');
      const priceInput = row.querySelector('input[name*="selling_price"]');
      
      if (productSelect && priceInput && productSelect.value) {
        const productId = productSelect.value;
        if (window.PRODUCT_PRICES && window.PRODUCT_PRICES[productId]) {
          priceInput.value = window.PRODUCT_PRICES[productId];
          updateRowTotal(row);
        }
      }
    }
    
    // Function to update the total for a row
    function updateRowTotal(row) {
      const quantityInput = row.querySelector('input[name*="quantity"]');
      const priceInput = row.querySelector('input[name*="selling_price"]');
      const totalInput = row.querySelector('.item-total');
      
      if (quantityInput && priceInput && totalInput) {
        const quantity = parseFloat(quantityInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const total = quantity * price;
        
        totalInput.value = total.toFixed(2);
        updateAllTotals();
      }
    }
    
    // Function to update all totals (subtotal, TVA, total)
    function updateAllTotals() {
      console.log('Updating all totals...');
      
      // Calculate subtotal
      let subtotal = 0;
      document.querySelectorAll('.item-total').forEach(input => {
        subtotal += parseFloat(input.value) || 0;
      });
      console.log('Calculated subtotal:', subtotal);
      
      // Get TVA rate
      const tvaRateInput = document.getElementById('id_tva_rate');
      let tvaRate = parseFloat(tvaRateInput.value) || 0;
      
      // Ensure TVA rate is not zero if it has a value
      if (tvaRateInput.value && tvaRate === 0) {
        console.warn('TVA rate input has value but parsed as 0, trying again:', tvaRateInput.value);
        // Try to parse again with different locale handling
        tvaRate = parseFloat(tvaRateInput.value.replace(',', '.')) || 0;
      }
      
      console.log('Using TVA rate:', tvaRate);
      
      // Update TVA rate display
      const tvaRateDisplay = document.getElementById('tva-rate-display');
      if (tvaRateDisplay) {
        tvaRateDisplay.textContent = tvaRate.toFixed(1);
      }
      
      // Calculate TVA amount
      const tvaAmount = subtotal * (tvaRate / 100);
      console.log('Calculated TVA amount:', tvaAmount);
      
      // Check if stamp fee is included
      const includeStampFee = document.getElementById('id_include_stamp_fee').checked;
      let stampFee = 0;
      if (includeStampFee) {
        // Get stamp fee from help text or use default
        const stampFeeText = document.querySelector('small.form-text.text-muted').textContent;
        const stampFeeMatch = stampFeeText.match(/stamp fee of (\d+(\.\d+)?)/);
        if (stampFeeMatch) {
          stampFee = parseFloat(stampFeeMatch[1]) || 1.0;
        } else {
          stampFee = 1.0; // Default value
        }
      }
      
      // Calculate total
      const total = subtotal + tvaAmount + stampFee;
      
      // Update display
      document.getElementById('subtotal').textContent = subtotal.toFixed(2);
      document.getElementById('tva-amount').textContent = tvaAmount.toFixed(2);
      document.getElementById('stamp-fee').textContent = stampFee.toFixed(2);
      document.getElementById('total-amount').textContent = total.toFixed(2);
      
      // Update hidden input for form submission
      document.getElementById('id_invoice_total').value = total.toFixed(2);
      
      // Show/hide stamp fee row
      const stampFeeRow = document.getElementById('stamp-fee-row');
      if (includeStampFee) {
        stampFeeRow.style.display = '';
      } else {
        stampFeeRow.style.display = 'none';
      }
    }
    
    // Function to setup the add item button
    function setupAddItemButton() {
      const addButton = document.getElementById('add-item');
      const tbody = document.getElementById('invoice-items-body');
      const emptyForm = document.getElementById('empty-form');
      
      addButton.addEventListener('click', function() {
        console.log('Add item button clicked');
        
        // Get the current form count
        const formCount = tbody.querySelectorAll('.item-form').length;
        console.log('Current form count:', formCount);
        
        // Find the formset prefix
        const totalFormsInput = document.querySelector('[name$="-TOTAL_FORMS"]');
        let prefix = 'invoiceitem_set';
        if (totalFormsInput) {
          const name = totalFormsInput.name;
          prefix = name.substring(0, name.indexOf('-TOTAL_FORMS'));
          console.log('Using formset prefix:', prefix);
        }
        
        // Create a new row by cloning the template
        const newRow = document.createElement('tr');
        newRow.classList.add('item-form');
        
        // Set the HTML content for the new row
        newRow.innerHTML = `
          <td>
            <select name="${prefix}-${formCount}-product" id="id_${prefix}-${formCount}-product" class="form-control select2-product">
              <option value="">Select a product...</option>
              {% for product in products %}
              <option value="{{ product.id }}" data-price="{{ product.selling_price }}">{{ product.name }}</option>
              {% endfor %}
            </select>
          </td>
          <td>
            <input type="text" 
                   name="${prefix}-${formCount}-quantity" 
                   id="id_${prefix}-${formCount}-quantity" 
                   class="form-control quantity-input-debug" 
                   value="1" 
                   data-field-type="quantity"
                   style="color: black !important; background-color: white !important; z-index: 9999 !important; opacity: 1 !important;" >
          </td>
          <td>
            <input type="text" 
                   name="${prefix}-${formCount}-selling_price" 
                   id="id_${prefix}-${formCount}-selling_price" 
                   class="form-control selling-price-input-debug" 
                   value="0.00" 
                   data-field-type="selling-price"
                   style="color: black !important; background-color: white !important; z-index: 9999 !important; opacity: 1 !important;" >
          </td>
          <td>
            <input type="number" class="form-control item-total" readonly>
          </td>
          <td>
            <button type="button" class="btn btn-sm btn-danger delete-row">
              <i class="fas fa-trash"></i> Remove
            </button>
          </td>
        `;
        
        // Append the new row to the tbody
        tbody.appendChild(newRow);
        
        // Initialize Select2 for the new row
        const newSelect = newRow.querySelector('select.select2-product');
        if (newSelect) {
          console.log('Initializing Select2 for new product dropdown');
          initializeNewSelect2(newSelect);
        } else {
          console.error('Could not find product select in new row');
        }
        
        // Setup event handlers for the new row
        setupRowEventHandlers(newRow);
        
        // Update the form count
        updateFormCount();
      });
    }
    
    // Function to update the form count in the management form
    function updateFormCount() {
      const totalForms = document.querySelector('[name$="-TOTAL_FORMS"]');
      if (totalForms) {
        const formCount = document.querySelectorAll('#invoice-items-body .item-form').length;
        totalForms.value = formCount;
        console.log('Updated form count:', formCount);
      }
    }
    
    // Function to remove empty rows (used in update mode)
    function removeEmptyRows() {
      if (window.isUpdateMode) {
        console.log('Update mode detected, checking for empty rows to remove');
        const rows = document.querySelectorAll('#invoice-items-body .item-form');
        let emptyRowsFound = false;
        
        rows.forEach(row => {
          // Check if this is an empty row using multiple methods
          const productSelect = row.querySelector('select[name*="product"]');
          const quantityInput = row.querySelector('input[name*="quantity"]');
          const priceInput = row.querySelector('input[name*="selling_price"]');
          const totalInput = row.querySelector('.item-total');
          
          // Check if product is empty (handle both native select and Select2)
          let productEmpty = false;
          if (productSelect) {
            // Check native select value
            if (!productSelect.value) {
              productEmpty = true;
            }
            // Also check Select2 text content if available
            const select2Container = row.querySelector('.select2-selection__rendered');
            if (select2Container && (select2Container.textContent.trim() === 'Select a product...' || 
                                     select2Container.textContent.trim() === '')) {
              productEmpty = true;
            }
          }
          
          // Check if quantity is default and price is zero/empty
          const isDefaultQuantity = quantityInput && (quantityInput.value === '1' || quantityInput.value === '');
          const isZeroPrice = priceInput && (priceInput.value === '0' || priceInput.value === '0.00' || priceInput.value === '');
          const isZeroTotal = totalInput && (totalInput.value === '0' || totalInput.value === '0.00' || totalInput.value === '');
          
          if (productEmpty && isDefaultQuantity && isZeroPrice) {
            console.log('Found empty row in update mode, removing it');
            row.remove();
            emptyRowsFound = true;
          }
        });
        
        // Update form count after removing empty rows
        if (emptyRowsFound) {
          updateFormCount();
        }
      }
    }
    
    // Initialize the form when the DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing invoice form...');
      
      // Initialize Select2 for product dropdowns
      initializeSelect2();
      
      // Setup event handlers for existing rows
      setupExistingRows();
      
      // Setup event handlers for the empty form template
      setupEmptyFormTemplate();
      
      // Setup event handlers for the add button
      setupAddItemButton();
      
      // Remove empty rows if in update mode - do this after a slight delay to ensure Select2 is fully initialized
      setTimeout(function() {
        removeEmptyRows();
      }, 300);
      
      // Setup event handler for the TVA rate input
      const tvaRateInput = document.getElementById('id_tva_rate');
      console.log('Initial TVA rate:', tvaRateInput.value);
      tvaRateInput.addEventListener('input', updateAllTotals);
      
      // Setup event handler for the include stamp fee checkbox
      document.getElementById('id_include_stamp_fee').addEventListener('change', updateAllTotals);
      
      // Force an initial calculation of all totals
      console.log('Forcing initial calculation of all totals');
      updateAllTotals();
    });
  });
</script>
{% endblock script_content %}
