{% extends 'base.html' %}
{% load static %}

{% block sidebar %}
{% include 'includes/sidebar.html' %}
{% endblock sidebar %}

{% block topbar %}
{% include 'includes/topbar.html' %}
{% endblock topbar %}

{% block extra_js %}
{{ block.super }}
<script>
  // Provide product prices for JS
  window.PRODUCT_PRICES = {
    {% for product in products %}
    "{{ product.id }}": "{{ product.selling_price }}"{% if not forloop.last %}, {% endif %}
    {% endfor %}
  };
</script>
<script src="{% static 'js/invoice_item_autofill.js' %}"></script>
{% endblock extra_js %}

{% block footer %}
{% include 'includes/footer.html' %}
{% endblock footer %}

{% block content %}
<style>
  /* Select2 Styling */
  .select2-container--default .select2-selection--single {
    border-color: #e0e6ed;
    border-radius: 8px;
    background-color: #f9f8ff;
    height: 38px;
    padding: 5px 10px;
  }

  .select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #6259FF;
    line-height: 28px;
  }

  .select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px;
  }

  .select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #eae9ff;
    color: #6259FF;
  }

  .select2-dropdown {
    border-color: #d7d5ff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(98, 89, 255, 0.08);
  }

  .select2-container--open .select2-dropdown--below {
    border-top: none;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
  }

  .select2-container--default .select2-search--dropdown .select2-search__field {
    border-color: #e0e6ed;
    border-radius: 4px;
    padding: 8px;
  }

  /* Modern table styling for invoice items */
  .modern-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(98, 89, 255, 0.08);
  }

  .modern-table thead th {
    padding: 12px 15px;
    font-weight: 600;
    color: #6259FF;
  }

  .modern-table tbody tr {
    transition: all 0.2s ease;
  }

  .modern-table tbody tr:hover {
    background-color: #f9f8ff;
  }

  .modern-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #eae9ff;
  }

  .modern-table tbody tr:last-child td {
    border-bottom: none;
  }
</style>

<div class="container-fluid p-0">
  <div class="col-12 col-lg-12 col-xxl-12 d-flex">
    <div class="card flex-fill shadow-lg" style="border-radius: 0.5rem;">
      <div class="card-header d-flex align-items-center"
        style="background: linear-gradient(90deg,#eae9ff 0%,#f9f8ff 100%); border-bottom: 1px solid #e0e6ed; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem;">
        <h3 class="card-title mb-0 text-dark d-flex align-items-center">
          <i class="fas fa-file-invoice me-2" style="color: #7cb9e8; font-size: 2rem;"></i>Invoice Form
        </h3>
      </div>
      <div class="card-body p-4">
        <!-- Error Messages Section -->
        {% if form.errors or formset.errors or formset.non_form_errors %}
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
          <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-3" style="font-size: 1.5rem;"></i>
            <div>
              <h5 class="alert-heading mb-1">Invoice Creation Failed</h5>
              <p class="mb-0">Please correct the following errors:</p>

              <!-- Form non-field errors (general errors) -->
              {% if form.non_field_errors %}
              <ul class="mt-2 mb-0">
                {% for error in form.non_field_errors %}
                <li><strong>{{ error }}</strong></li>
                {% endfor %}
              </ul>
              {% endif %}

              <!-- Formset non-form errors (formset-level validation errors) -->
              {% if formset.non_form_errors %}
              <ul class="mt-2 mb-0">
                {% for error in formset.non_form_errors %}
                <li><strong>{{ error }}</strong></li>
                {% endfor %}
              </ul>
              {% endif %}

              <!-- Individual formset form errors -->
              {% if formset.errors %}
              <ul class="mt-2 mb-0">
                {% for form_errors in formset.errors %}
                  {% for field, errors in form_errors.items %}
                    {% for error in errors %}
                    <li><strong>Product Item {{ forloop.parentloop.parentloop.counter }}:</strong> {{ error }}</li>
                    {% endfor %}
                  {% endfor %}
                {% endfor %}
              </ul>
              {% endif %}
            </div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <form method="post" id="invoice-form" autocomplete="off" class="w-100">
          {% csrf_token %}
          <div class="mb-4">
            <h4 class="fw-bold mb-3" style="color: #39739d;"><i class="fas fa-info-circle me-2"
                style="color: #7cb9e8;"></i>Invoice Details</h4>
            <div class="row g-3">
              <!-- TVA Rate Field -->
              <div class="col-md-6">
                <label class="form-label fw-semibold" for="id_tva_rate">TVA Rate (%)</label>
                {{ form.tva_rate.as_hidden }}
                <div class="form-control bg-light" style="color: #39739d; font-weight: 600;">{{ form.initial.tva_rate|default:'19.0' }}%</div>
                <small class="form-text text-muted">Default rate from company settings ({{ form.initial.tva_rate|default:'19.0' }})</small>
                {% for error in form.tva_rate.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>

              <!-- Stamp Fee Field -->
              <div class="col-md-6">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" name="include_stamp_fee" id="id_include_stamp_fee" {% if form.include_stamp_fee.value or form.initial.include_stamp_fee %}checked{% endif %}>
                  <label class="form-check-label" for="id_include_stamp_fee">
                    Include Stamp Fee
                  </label>
                  <small class="form-text text-muted d-block">{{ form.include_stamp_fee.help_text }}</small>
                  {% for error in form.include_stamp_fee.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                </div>
              </div>

              <!-- Client Name Field -->
              <div class="col-md-6">
                <label class="form-label fw-semibold" for="id_client_name">Client Name</label>
                <input type="text" name="client_name" id="id_client_name" class="form-control" placeholder="Client name"
                  value="{{ form.client_name.value|default:'' }}">
                {% if form.client_name.help_text %}<small class="form-text text-muted">{{ form.client_name.help_text }}</small>{% endif %}
                {% for error in form.client_name.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>

              <!-- Client Address Field -->
              <div class="col-md-6">
                <label class="form-label fw-semibold" for="id_client_address">Client Address</label>
                <textarea name="client_address" id="id_client_address" class="form-control"
                  placeholder="Client address">{{ form.client_address.value|default:'' }}</textarea>
                {% if form.client_address.help_text %}<small class="form-text text-muted">{{ form.client_address.help_text }}</small>{% endif %}
                {% for error in form.client_address.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
            </div>
          </div>

          <!-- Invoice Items Section -->
          <div class="mb-4">
            <h4 class="fw-bold mb-3" style="color: #39739d;"><i class="fas fa-list-ul me-2"
                style="color: #7cb9e8;"></i>Invoice Items</h4>

            <!-- Management form for formset -->
            {{ formset.management_form }}

            <div class="table-responsive">
              <table class="modern-table">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="invoice-items-body">
                  {% for form in formset %}
                  <tr class="item-form">
                    <td>
                      {{ form.id }}
                      <select name="{{ form.product.html_name }}" id="{{ form.product.auto_id }}"
                        class="form-control select2" style="width: 100%;">
                        <option value="">Select a product</option>
                        {% for product in products %}
                        <option value="{{ product.id }}" {% if form.product.value == product.id|stringformat:"i" %}selected{% endif %}>
                          {{ product.name }} ({{ product.sku }})
                        </option>
                        {% endfor %}
                      </select>
                      {% for error in form.product.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </td>
                    <td>
                      <input type="number" name="{{ form.quantity.html_name }}" id="{{ form.quantity.auto_id }}"
                        class="form-control item-quantity" min="1" step="1" placeholder="Quantity"
                        value="{{ form.quantity.value|default:'1' }}">
                      {% for error in form.quantity.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </td>
                    <td>
                      <input type="number" name="{{ form.selling_price.html_name }}" id="{{ form.selling_price.auto_id }}"
                        class="form-control item-price" min="0" step="0.01" placeholder="Unit price"
                        value="{{ form.selling_price.value|default:'0.00' }}">
                      {% for error in form.selling_price.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </td>
                    <td>
                      <input type="number" name="{{ form.total_price.html_name }}" id="{{ form.total_price.auto_id }}"
                        class="form-control item-total" readonly placeholder="Total"
                        value="{{ form.total_price.value|default:'0.00' }}">
                      {% for error in form.total_price.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </td>
                    <td>
                      <button type="button" class="btn btn-danger btn-sm delete-row"
                        style="border-radius: 0.5rem;">Remove</button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <button type="button" class="btn btn-info mb-3 rounded shadow-sm px-4" id="add-item"
              style="background: #7cb9e8; border: none; color: #fff; font-weight: 600; border-radius: 0.5rem; margin-top: 15px;">
              <i class="fa fa-plus me-2"></i> Add Another Item
            </button>
          </div>
          
          <div class="row mt-4 mb-2 justify-content-end">
            <div class="col-md-4">
              <div class="p-3" style="background: #eae9ff; border-radius: 0.5rem;">
                <label for="invoice-total-price" class="fw-bold mb-2" style="color: #39739d;">Invoice Total</label>
                <input type="number" step="0.01" class="form-control form-control-lg invoice-grand-total"
                  id="invoice-total-price" name="invoice_total" value="" placeholder="Total invoice amount" />
              </div>
            </div>
          </div>
          
          <div class="mt-4 d-flex justify-content-end">
            <button type="submit" class="btn rounded shadow-sm px-5"
              style="background: #eae9ff; color: #39739d; border: 1px solid #dbeafe;">
              <i class="fas fa-save me-1"></i> Save Invoice
            </button>
            <a href="{% url 'invoice-list' %}" class="btn btn-secondary ms-3">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block script_content %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2 for all product dropdowns
    $('.select2').select2({
      width: '100%',
      dropdownCssClass: 'select2-dropdown-modern',
      theme: 'classic'
    });
    
    // Get references to key elements
    const addButton = document.getElementById('add-item');
    const tbody = document.getElementById('invoice-items-body');
    const totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
    const initialFormsInput = document.getElementById('id_items-INITIAL_FORMS');
    const maxFormsInput = document.getElementById('id_items-MAX_NUM_FORMS');
    
    if (!totalFormsInput || !initialFormsInput || !maxFormsInput) {
      console.error('[Invoice JS] Management form not found!');
      return;
    }
    
    // Function to update the form count
    function updateFormCount() {
      const count = tbody.querySelectorAll('.item-form').length;
      totalFormsInput.value = count;
      console.log('[Invoice JS] Updated form count:', count);
    }
    
    // Function to setup delete buttons
    function setupDeleteButtons() {
      tbody.querySelectorAll('.delete-row').forEach(button => {
        button.onclick = function() {
          const removedRow = this.closest('tr');
          removedRow.remove();
          updateFormCount();
          console.log('[Invoice JS] Removed an item row.');
        };
      });
    }
    
    // Initialize delete buttons
    setupDeleteButtons();
    
    // Function to add a new item row
    addButton.addEventListener('click', function() {
      // Get the current form count
      const formCount = parseInt(totalFormsInput.value);
      
      // Create a new row
      const newRow = document.createElement('tr');
      newRow.className = 'item-form';
      
      // Get a template for the new row
      const formRegex = /__prefix__/g;
      
      // Get the empty form HTML from the Django template
      const emptyFormHTML = `
        <td>
          {{ formset.empty_form.id }}
          <select name="{{ formset.empty_form.product.html_name }}" 
                 id="{{ formset.empty_form.product.auto_id }}" 
                 class="form-control select2" style="width: 100%;">
            <option value="">Select a product</option>
            {% for product in products %}
            <option value="{{ product.id }}">{{ product.name }} ({{ product.sku }})</option>
            {% endfor %}
          </select>
        </td>
        <td>
          <input type="number" name="{{ formset.empty_form.quantity.html_name }}" 
                id="{{ formset.empty_form.quantity.auto_id }}" 
                class="form-control item-quantity" min="1" step="1" 
                placeholder="Quantity" value="1">
        </td>
        <td>
          <input type="number" name="{{ formset.empty_form.selling_price.html_name }}" 
                id="{{ formset.empty_form.selling_price.auto_id }}" 
                class="form-control item-price" min="0" step="0.01" 
                placeholder="Unit price" value="0.00">
        </td>
        <td>
          <input type="number" name="{{ formset.empty_form.total_price.html_name }}" 
                id="{{ formset.empty_form.total_price.auto_id }}" 
                class="form-control item-total" readonly 
                placeholder="Total" value="0.00">
        </td>
        <td>
          <button type="button" class="btn btn-danger btn-sm delete-row" 
                 style="border-radius: 0.5rem;">Remove</button>
        </td>
      `;
      
      // Replace the __prefix__ placeholder with the actual form index
      newRow.innerHTML = emptyFormHTML.replace(formRegex, formCount);
      
      // Add the new row to the tbody
      tbody.appendChild(newRow);
      
      // Update the form count
      totalFormsInput.value = formCount + 1;
      
      // Initialize Select2 for the new row
      $(newRow).find('.select2').select2({
        width: '100%',
        dropdownCssClass: 'select2-dropdown-modern',
        theme: 'classic'
      });
      
      // Setup delete button for the new row
      setupDeleteButtons();
      
      console.log('[Invoice JS] Added a new item row.');
    });
    
    // Function to calculate item totals
    function calculateItemTotal(row) {
      const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
      const price = parseFloat(row.querySelector('.item-price').value) || 0;
      const total = quantity * price;
      row.querySelector('.item-total').value = total.toFixed(2);
      return total;
    }
    
    // Function to calculate invoice total
    function calculateInvoiceTotal() {
      let grandTotal = 0;
      const rows = tbody.querySelectorAll('.item-form');
      
      rows.forEach(row => {
        grandTotal += calculateItemTotal(row);
      });
      
      document.getElementById('invoice-total-price').value = grandTotal.toFixed(2);
    }
    
    // Add event listeners for quantity and price changes
    tbody.addEventListener('input', function(e) {
      if (e.target.classList.contains('item-quantity') || e.target.classList.contains('item-price')) {
        calculateInvoiceTotal();
      }
    });
    
    // Initialize totals
    calculateInvoiceTotal();
  });
</script>
{% endblock script_content %}
