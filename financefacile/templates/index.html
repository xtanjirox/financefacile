{% extends 'base.html' %}

{% block sidebar %}
{% include 'includes/sidebar.html' %}
{% endblock sidebar %}

{% block topbar %}
{% include 'includes/topbar.html' %}
{% endblock topbar %}

{% block footer %}
{% include 'includes/footer.html' %}
{% endblock footer %}

{% block content %}
<div class="container-fluid p-0">

    <h1 class="h3 mb-3">Finance <strong>Facile</strong></h1>

    <style>
        .dashboard-card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(60, 60, 120, 0.06);
            padding: 0.7rem 1rem;
            min-height: 90px;
            display: flex;
            align-items: center;
            background: #fff;
            transition: box-shadow 0.2s, transform 0.2s;
        }

        .dashboard-card:hover {
            box-shadow: 0 4px 24px 0 rgba(60, 60, 120, 0.13), 0 1.5px 4px 0 rgba(60, 60, 120, 0.10);
            transform: translateY(-2px) scale(1.01);
        }

        .dashboard-card.bg-prod {
            background: #e3f2fd;
        }

        .dashboard-card.bg-items {
            background: #e8f5e9;
        }

        .dashboard-card.bg-value {
            background: #fff8e1;
        }

        .dashboard-card.bg-invoice {
            background: #fce4ec;
        }

        .dashboard-card .icon {
            font-size: 1.35rem;
            margin-right: 0.7rem;
            opacity: 0.7;
        }

        .dashboard-card .card-title {
            font-size: 1.05rem;
            font-weight: 500;
            margin-bottom: 0.2rem;
        }

        .dashboard-card .fw-bold {
            font-size: 1.35rem;
            font-weight: 700;
            margin-bottom: 0;
        }
    </style>
    <div class="row g-4 mb-4">
        <div class="col-12 col-md-6 col-xl-3">
            <div class="dashboard-card bg-prod">
                <span class="icon"><i class="bi bi-box-seam"></i></span>
                <div>
                    <div class="card-title text-muted">Nombre de produits</div>
                    <div class="fw-bold">{{ product_count }}</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div class="dashboard-card bg-items">
                <span class="icon"><i class="bi bi-stack"></i></span>
                <div>
                    <div class="card-title text-muted">Articles en stock</div>
                    <div class="fw-bold">{{ total_pieces }}</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div class="dashboard-card bg-value">
                <span class="icon"><i class="bi bi-cash-stack"></i></span>
                <div>
                    <div class="card-title text-muted">Valeur du stock</div>
                    <div class="fw-bold">{{ warehouse_value|floatformat:2 }} dt</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div class="dashboard-card bg-invoice">
                <span class="icon"><i class="bi bi-receipt"></i></span>
                <div>
                    <div class="card-title text-muted">Total factures</div>
                    <div class="fw-bold">{{ total_invoice_price|floatformat:2 }} dt</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-2">
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm border-0" style="margin-bottom:0;">
                <div class="card-body p-2 text-center">
                    <h6 class="card-title text-muted mb-1" style="font-size:0.85rem;">Répartition des articles par catégorie principale</h6>
                    <canvas id="pie-products-category" width="120" height="120" style="display:inline-block;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm border-0" style="margin-bottom:0;">
                <div class="card-body p-2 text-center">
                    <h6 class="card-title text-muted mb-1" style="font-size:0.85rem;">Valeur du stock par catégorie principale</h6>
                    <canvas id="pie-value-category" width="120" height="120" style="display:inline-block;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm border-0" style="margin-bottom:0;">
                <div class="card-body p-2 text-center">
                    <h6 class="card-title text-muted mb-1" style="font-size:0.85rem;">Produits vendus par catégorie principale</h6>
                    <canvas id="pie-invoice-category" width="120" height="120" style="display:inline-block;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Invoices Table -->
    <div class="card mt-4">
        <div class="card-header py-2 bg-white border-0">
            <span class="fw-semibold">Dernières factures créées</span>
        </div>
        <div class="table-responsive mb-0">
            <table class="table table-sm table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Date</th>
                        <th scope="col">Total</th>
                        <th scope="col">Action</th>
                    </tr>
                </thead>
                <tbody>
                {% for invoice in recent_invoices %}
                    <tr style="cursor:pointer" onclick="window.location='{{ invoice.get_absolute_url }}'">
                        <td>INV-{{ invoice.pk }}</td>
                        <td>{{ invoice.created_at|date:'Y-m-d H:i' }}</td>
                        <td>{{ invoice.get_total|floatformat:2 }} <span class="text-muted">dt</span></td>
                        <td>
                            <a href="{{ invoice.get_absolute_url }}" class="btn btn-sm shadow-sm" style="background: #e3f2fd; color: #1976d2; border-radius: 7px; font-weight: 500; border: none;" data-bs-toggle="tooltip" title="View">
                                <i class="fas fa-eye" aria-hidden="true"></i>
                            </a>
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="4" class="text-center text-muted">Aucune facture récente.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endblock content %}


    {% block script_content %}

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Pie Chart: Products by Parent Category
            const pieProductsData = JSON.parse('{{ pie_products_by_category|escapejs }}');
            const ctxProducts = document.getElementById('pie-products-category').getContext('2d');
            new Chart(ctxProducts, {
                type: 'pie',
                data: Object.assign({}, pieProductsData, {
                    datasets: pieProductsData.datasets.map(ds => Object.assign({}, ds, {
                        backgroundColor: [
                            '#bbdefb', '#c8e6c9', '#ffe0b2', '#f8bbd0', '#d1c4e9', '#fff9c4', '#b2dfdb', '#f0f4c3', '#f5f5f5', '#e1bee7'
                        ]
                    }))
                }),
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' }
                    }
                }
            });

            // Pie Chart: Inventory Value by Parent Category
            const pieValueData = JSON.parse('{{ pie_value_by_category|escapejs }}');
            const ctxValue = document.getElementById('pie-value-category').getContext('2d');
            new Chart(ctxValue, {
                type: 'pie',
                data: Object.assign({}, pieValueData, {
                    datasets: pieValueData.datasets.map(ds => Object.assign({}, ds, {
                        backgroundColor: [
                            '#bbdefb', '#c8e6c9', '#ffe0b2', '#f8bbd0', '#d1c4e9', '#fff9c4', '#b2dfdb', '#f0f4c3', '#f5f5f5', '#e1bee7'
                        ]
                    }))
                }),
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' }
                    }
                }
            });

            // Pie Chart: Invoices by Parent Category (sold products)
            const pieInvoiceData = JSON.parse('{{ pie_invoice_by_category|escapejs }}');
            const ctxInvoice = document.getElementById('pie-invoice-category').getContext('2d');
            new Chart(ctxInvoice, {
                type: 'pie',
                data: Object.assign({}, pieInvoiceData, {
                    datasets: pieInvoiceData.datasets.map(ds => Object.assign({}, ds, {
                        backgroundColor: [
                            '#bbdefb', '#c8e6c9', '#ffe0b2', '#f8bbd0', '#d1c4e9', '#fff9c4', '#b2dfdb', '#f0f4c3', '#f5f5f5', '#e1bee7'
                        ]
                    }))
                }),
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' }
                    }
                }
            });
        });
    </script>
    {% endblock script_content %}